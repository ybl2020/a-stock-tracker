<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aè‚¡ç›¯ç›˜ç¥å™¨ Pro</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .navbar {
            background: rgba(15,15,26,0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.5em; font-weight: bold; color: #00d4ff; }
        .nav-links { display: flex; gap: 30px; }
        .nav-links a { color: rgba(255,255,255,0.6); text-decoration: none; cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: #00d4ff; }
        .btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            color: #fff;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
        }
        .page { display: none; padding: 30px; max-width: 1400px; margin: 0 auto; }
        .page.active { display: block; }
        .hero { text-align: center; padding: 80px 20px; }
        .hero h1 { font-size: 3em; color: #00d4ff; margin-bottom: 20px; }
        .hero p { font-size: 1.2em; color: rgba(255,255,255,0.6); margin-bottom: 40px; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; padding: 40px 0; }
        .feature-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }
        .feature-card .icon { font-size: 3em; margin-bottom: 15px; }
        .search-container { max-width: 800px; margin: 0 auto; }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        .search-box input {
            flex: 1;
            padding: 15px 25px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 30px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1em;
        }
        .search-results {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .portfolio-stats { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px 30px;
            min-width: 150px;
        }
        .stat-card .label { color: rgba(255,255,255,0.6); font-size: 0.9em; margin-bottom: 8px; }
        .stat-card .value { font-size: 1.8em; font-weight: bold; }
        .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .stock-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
        }
        .stock-card.up { border-left: 4px solid #ff4757; }
        .stock-card.down { border-left: 4px solid #2ed573; }
        .stock-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .stock-price-main { font-size: 2em; font-weight: bold; }
        .change-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .change-badge.up { background: rgba(255,71,87,0.2); color: #ff4757; }
        .change-badge.down { background: rgba(46,213,115,0.2); color: #2ed573; }
        .position-info {
            background: rgba(0,212,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
        }
        .detail-layout { display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
        .chart-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            height: 500px;
        }
        #klineChart { height: calc(100% - 50px); }
        .info-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .position-form { display: flex; flex-direction: column; gap: 12px; }
        .position-form input {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #0f0f1a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 1em;
        }
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-weight: bold;
            display: none;
            z-index: 2000;
        }
        .toast.show { display: block; }
        .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.6); }
        @media (max-width: 1024px) {
            .detail-layout { grid-template-columns: 1fr; }
            .nav-links { display: none; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">ğŸ“ˆ Aè‚¡ç›¯ç›˜ç¥å™¨</div>
        <div class="nav-links">
            <a onclick="showPage('home')" data-page="home">é¦–é¡µ</a>
            <a onclick="showPage('search')" data-page="search">æœç´¢</a>
            <a onclick="showPage('portfolio')" data-page="portfolio">è‡ªé€‰</a>
        </div>
        <div>
            <span id="userDisplay" style="display:none; margin-right:10px;"></span>
            <button id="loginBtn" class="btn" onclick="showLoginModal()">ç™»å½•</button>
            <button id="logoutBtn" class="btn btn-outline" onclick="logout()" style="display:none;">é€€å‡º</button>
        </div>
    </nav>

    <div id="page-home" class="page active">
        <div class="hero">
            <h1>æ™ºèƒ½ç›¯ç›˜ï¼Œè½»æ¾æŠ•èµ„</h1>
            <p>å®æ—¶è¡Œæƒ…ã€æˆæœ¬è®°å½•ã€Kçº¿åˆ†æï¼Œä¸€ç«™å¼è‚¡ç¥¨æŠ•èµ„åŠ©æ‰‹</p>
            <button class="btn" onclick="showPage('search')" style="padding:15px 40px;font-size:1.1em;">ç«‹å³å¼€å§‹</button>
        </div>
        <div class="features">
            <div class="feature-card"><div class="icon">ğŸ“Š</div><h3>å®æ—¶è¡Œæƒ…</h3><p>5ç§’è‡ªåŠ¨åˆ·æ–°</p></div>
            <div class="feature-card"><div class="icon">ğŸ’°</div><h3>æˆæœ¬è®°å½•</h3><p>å®æ—¶è®¡ç®—ç›ˆäº</p></div>
            <div class="feature-card"><div class="icon">ğŸ“ˆ</div><h3>Kçº¿å›¾è¡¨</h3><p>ä¸“ä¸šèµ°åŠ¿åˆ†æ</p></div>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°ï¼ˆå¦‚ï¼š600519 æˆ– èŒ…å°ï¼‰" onkeypress="if(event.keyCode===13)searchStocks()">
                <button class="btn" onclick="searchStocks()">ğŸ” æœç´¢</button>
            </div>
            <div id="searchResults" style="display:none;"></div>
        </div>
    </div>

    <div id="page-portfolio" class="page">
        <div id="portfolioContent"></div>
    </div>

    <div id="page-detail" class="page">
        <div style="margin-bottom:20px;">
            <button class="btn btn-outline" onclick="showPage('portfolio')">â† è¿”å›è‡ªé€‰</button>
        </div>
        <div class="detail-layout">
            <div class="chart-container">
                <h3 id="detailStockName">--</h3>
                <div id="klineChart"></div>
            </div>
            <div>
                <div class="info-card">
                    <h3>ğŸ“Š å®æ—¶è¡Œæƒ…</h3>
                    <div class="info-row"><span>æœ€æ–°ä»·</span><span id="detailPrice">--</span></div>
                    <div class="info-row"><span>æ¶¨è·Œå¹…</span><span id="detailChange">--</span></div>
                </div>
                <div class="info-card" id="positionCard" style="display:none;">
                    <h3>ğŸ’° æˆ‘çš„æŒä»“</h3>
                    <div class="position-form">
                        <input type="number" id="positionCost" placeholder="æˆæœ¬ä»·" step="0.01">
                        <input type="number" id="positionShares" placeholder="æŒä»“æ•°é‡">
                        <button class="btn" onclick="savePosition()">ä¿å­˜æŒä»“</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">ç™»å½•</h2>
            <div class="form-group"><input type="text" id="username" placeholder="ç”¨æˆ·å"></div>
            <div class="form-group"><input type="password" id="password" placeholder="å¯†ç "></div>
            <button class="btn" onclick="handleAuth()" style="width:100%;">ç™»å½•</button>
            <div style="text-align:center;margin-top:20px;color:rgba(255,255,255,0.6);">
                <a onclick="toggleAuthMode()" style="color:#00d4ff;cursor:pointer;">åˆ‡æ¢æ³¨å†Œ/ç™»å½•</a>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ES5å…¼å®¹ä»£ç 
        var currentUser = null;
        var watchlist = {};
        var stockData = {};
        var currentDetailStock = null;
        var isLoginMode = true;

        // åˆå§‹åŒ–
        window.onload = function() {
            var savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                var savedWatchlist = localStorage.getItem('watchlist');
                if (savedWatchlist) {
                    watchlist = JSON.parse(savedWatchlist);
                }
            }
            updateAuthUI();
        };

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#2ed573' : type === 'error' ? '#ff4757' : '#00d4ff';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function showPage(page) {
            var pages = document.querySelectorAll('.page');
            for (var i = 0; i < pages.length; i++) {
                pages[i].classList.remove('active');
            }
            document.getElementById('page-' + page).classList.add('active');
            
            if (page === 'portfolio') {
                renderPortfolio();
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('modalTitle').textContent = isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ';
        }

        function handleAuth() {
            var username = document.getElementById('username').value.trim();
            var password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }
            
            var users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (isLoginMode) {
                if (!users[username] || users[username].password !== password) {
                    showToast('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                    return;
                }
            } else {
                if (users[username]) {
                    showToast('ç”¨æˆ·åå·²å­˜åœ¨', 'error');
                    return;
                }
                users[username] = { password: password };
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            currentUser = username;
            localStorage.setItem('currentUser', username);
            hideLoginModal();
            updateAuthUI();
            showToast(isLoginMode ? 'ç™»å½•æˆåŠŸ' : 'æ³¨å†ŒæˆåŠŸ', 'success');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateAuthUI();
            showToast('å·²é€€å‡º', 'info');
            showPage('home');
        }

        function updateAuthUI() {
            var loginBtn = document.getElementById('loginBtn');
            var logoutBtn = document.getElementById('logoutBtn');
            var userDisplay = document.getElementById('userDisplay');
            
            if (currentUser) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userDisplay.style.display = 'inline';
                userDisplay.textContent = 'ğŸ‘¤ ' + currentUser;
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userDisplay.style.display = 'none';
            }
        }

        // è‚¡ç¥¨æ•°æ®åº“
        var stockDB = [
            {code:'600519', name:'è´µå·èŒ…å°', pinyin:'maotai'},
            {code:'000001', name:'å¹³å®‰é“¶è¡Œ', pinyin:'pinganyinhang'},
            {code:'300750', name:'å®å¾·æ—¶ä»£', pinyin:'ningdeshidai'},
            {code:'000858', name:'äº”ç²®æ¶²', pinyin:'wuliangye'},
            {code:'002594', name:'æ¯”äºšè¿ª', pinyin:'biyadi'},
            {code:'600036', name:'æ‹›å•†é“¶è¡Œ', pinyin:'zhaoshangyinhang'},
            {code:'000333', name:'ç¾çš„é›†å›¢', pinyin:'meidijituan'},
            {code:'002415', name:'æµ·åº·å¨è§†', pinyin:'haikangweishi'},
            {code:'600276', name:'æ’ç‘åŒ»è¯', pinyin:'hengruiyiyao'},
            {code:'002230', name:'ç§‘å¤§è®¯é£', pinyin:'kaidaxunfei'}
        ];

        function searchStocks() {
            var query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) return;
            
            var results = [];
            for (var i = 0; i < stockDB.length; i++) {
                var s = stockDB[i];
                if (s.code.indexOf(query) !== -1 || s.name.indexOf(query) !== -1 || s.pinyin.indexOf(query) !== -1) {
                    results.push(s);
                }
            }
            
            renderSearchResults(results);
        }

        function renderSearchResults(results) {
            var container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.6);">æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨</div>';
                container.style.display = 'block';
                return;
            }
            
            var html = '<div class="search-results">';
            for (var i = 0; i < results.length; i++) {
                var stock = results[i];
                var isWatched = currentUser && watchlist[currentUser] && watchlist[currentUser][stock.code];
                html += '<div class="search-result-item">' +
                    '<div><h4>' + stock.name + '</h4><span style="color:rgba(255,255,255,0.6);">' + stock.code + '</span></div>' +
                    '<button class="btn" ' + (isWatched ? 'disabled style="opacity:0.5;"' : 'onclick="addStock(\''+stock.code+'\',\''+stock.name+'\')"') + '>' +
                    (isWatched ? 'å·²æ·»åŠ ' : '+ æ·»åŠ è‡ªé€‰') + '</button>' +
                    '</div>';
            }
            html += '</div>';
            container.innerHTML = html;
            container.style.display = 'block';
        }

        function addStock(code, name) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                showLoginModal();
                return;
            }
            
            if (!watchlist[currentUser]) {
                watchlist[currentUser] = {};
            }
            
            if (watchlist[currentUser][code]) {
                showToast('è¯¥è‚¡ç¥¨å·²åœ¨è‡ªé€‰åˆ—è¡¨ä¸­', 'info');
                return;
            }
            
            watchlist[currentUser][code] = { name: name, cost: null, shares: null };
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            showToast('æ·»åŠ æˆåŠŸ', 'success');
            searchStocks();
        }

        function removeStock(code) {
            if (!currentUser || !watchlist[currentUser]) return;
            delete watchlist[currentUser][code];
            localStorage.setItem('watchlist', JSON.stringify(watchlist));
            renderPortfolio();
            showToast('å·²åˆ é™¤', 'info');
        }

        function renderPortfolio() {
            var container = document.getElementById('portfolioContent');
            
            if (!currentUser) {
                container.innerHTML = '<div class="empty-state"><div style="font-size:4em;margin-bottom:20px;">ğŸ”’</div><h3>è¯·å…ˆç™»å½•</h3><p>ç™»å½•åå¯ä»¥æ·»åŠ è‡ªé€‰è‚¡</p><button class="btn" onclick="showLoginModal()">ç«‹å³ç™»å½•</button></div>';
                return;
            }
            
            var myStocks = watchlist[currentUser] || {};
            var stockList = [];
            for (var code in myStocks) {
                if (myStocks.hasOwnProperty(code)) {
                    stockList.push({ code: code, data: myStocks[code] });
                }
            }
            
            if (stockList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="font-size:4em;margin-bottom:20px;">ğŸ“Š</div><h3>æš‚æ— è‡ªé€‰è‚¡</h3><p>å»æœç´¢é¡µé¢æ·»åŠ ä½ å…³æ³¨çš„è‚¡ç¥¨</p><button class="btn" onclick="showPage(\'search\')">å»æœç´¢</button></div>';
                return;
            }
            
            // è®¡ç®—æ€»ç›ˆäº
            var totalCost = 0, totalValue = 0, todayProfit = 0;
            for (var i = 0; i < stockList.length; i++) {
                var s = stockList[i];
                var data = stockData[s.code];
                if (data && s.data.cost && s.data.shares) {
                    totalCost += s.data.cost * s.data.shares;
                    totalValue += data.price * s.data.shares;
                    todayProfit += data.change * s.data.shares;
                }
            }
            var totalProfit = totalValue - totalCost;
            var profitPercent = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;
            
            var html = '<div class="portfolio-stats">' +
                '<div class="stat-card"><div class="label">æ€»ç›ˆäº</div><div class="value ' + (totalProfit >= 0 ? 'up' : 'down') + '"'>' + (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2) + '</div></div>' +
                '<div class="stat-card"><div class="label">ç›ˆäºæ¯”ä¾‹</div><div class="value ' + (profitPercent >= 0 ? 'up' : 'down') + '"'>' + (profitPercent >= 0 ? '+' : '') + profitPercent.toFixed(2) + '%</div></div>' +
                '<div class="stat-card"><div class="label">ä»Šæ—¥ç›ˆäº</div><div class="value ' + (todayProfit >= 0 ? 'up' : 'down') + '"'>' + (todayProfit >= 0 ? '+' : '') + todayProfit.toFixed(2) + '</div></div>' +
                '<div class="stat-card"><div class="label">æŒä»“å¸‚å€¼</div><div class="value">' + totalValue.toFixed(2) + '</div></div>' +
                '</div>' +
                '<div class="stock-grid">';
            
            for (var i = 0; i < stockList.length; i++) {
                html += renderStockCard(stockList[i].code, stockList[i].data);
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderStockCard(code, stock) {
            var data = stockData[code];
            if (!data) {
                return '<div class="stock-card" onclick="showStockDetail(\''+code+'\')">' +
                    '<div class="stock-header"><div><h3>' + stock.name + '</h3><span style="color:rgba(255,255,255,0.6);">' + code + '</span></div>' +
                    '<button class="btn btn-outline" onclick="event.stopPropagation();removeStock(\''+code+'\')">åˆ é™¤</button></div>' +
                    '<div style="color:rgba(255,255,255,0.6);padding:20px;">åŠ è½½ä¸­...</div></div>';
            }
            
            var isUp = data.change >= 0;
            var html = '<div class="stock-card ' + (isUp ? 'up' : 'down') + '" onclick="showStockDetail(\''+code+'\')">' +
                '<div class="stock-header"><div><h3>' + data.name + '</h3><span style="color:rgba(255,255,255,0.6);">' + code + '</span></div>' +
                '<button class="btn btn-outline" onclick="event.stopPropagation();removeStock(\''+code+'\')">åˆ é™¤</button></div>' +
                '<div class="stock-price-main">' + data.price.toFixed(2) + '</div>' +
                '<div class="stock-change">' +
                '<span class="change-badge ' + (isUp ? 'up' : 'down') + '"'>' + (isUp ? '+' : '') + data.change.toFixed(2) + '</span>' +
                '<span class="change-badge ' + (isUp ? 'up' : 'down') + '"'>' + (isUp ? '+' : '') + data.changePercent.toFixed(2) + '%</span>' +
                '</div>';
            
            if (stock.cost && stock.shares) {
                var cost = stock.cost * stock.shares;
                var value = data.price * stock.shares;
                var profit = value - cost;
                var profitPercent = (profit / cost * 100);
                var isProfitUp = profit >= 0;
                html += '<div class="position-info">' +
                    '<div style="display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:8px;">' +
                    '<span>æˆæœ¬ ' + stock.cost.toFixed(2) + ' Ã— ' + stock.shares + 'è‚¡</span>' +
                    '<span>å¸‚å€¼ ' + value.toFixed(2) + '</span></div>' +
                    '<div style="display:flex;justify-content:space-between;">' +
                    '<span>ç›ˆäº</span><span style="font-weight:bold;color:' + (isProfitUp ? '#ff4757' : '#2ed573') + '">' +
                    (isProfitUp ? '+' : '') + profit.toFixed(2) + ' (' + (isProfitUp ? '+' : '') + profitPercent.toFixed(2) + '%)</span></div>' +
                    '</div>';
            }
            html += '</div>';
            return html;
        }

        function showStockDetail(code) {
            currentDetailStock = code;
            showPage('detail');
            
            var stock = watchlist[currentUser] && watchlist[currentUser][code];
            var data = stockData[code];
            
            if (data) {
                document.getElementById('detailStockName').textContent = data.name + ' (' + code + ')';
                document.getElementById('detailPrice').textContent = data.price.toFixed(2);
                var changeText = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + ' (' + (data.change >= 0 ? '+' : '') + data.changePercent.toFixed(2) + '%)';
                document.getElementById('detailChange').textContent = changeText;
                document.getElementById('detailChange').style.color = data.change >= 0 ? '#ff4757' : '#2ed573';
            }
            
            var positionCard = document.getElementById('positionCard');
            if (currentUser && stock) {
                positionCard.style.display = 'block';
                document.getElementById('positionCost').value = stock.cost || '';
                document.getElementById('positionShares').value = stock.shares || '';
            } else {
                positionCard.style.display = 'none';
            }
            
            initKlineChart();
        }

        function savePosition() {
            if (!currentUser || !currentDetailStock) return;
            
            var cost = parseFloat(document.getElementById('positionCost').value);
            var shares = parseInt(document.getElementById('positionShares').value);
            
            if (!cost || !shares || cost <= 0 || shares <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆæœ¬ä»·å’Œæ•°é‡', 'error');
                return;
            }
            
            if (watchlist[currentUser] && watchlist[currentUser][currentDetailStock]) {
                watchlist[currentUser][currentDetailStock].cost = cost;
                watchlist[currentUser][currentDetailStock].shares = shares;
                localStorage.setItem('watchlist', JSON.stringify(watchlist));
                showToast('ä¿å­˜æˆåŠŸ', 'success');
            }
        }

        function initKlineChart() {
            var chartContainer = document.getElementById('klineChart');
            if (!chartContainer || typeof LightweightCharts === 'undefined') return;
            
            chartContainer.innerHTML = '';
            
            var chart = LightweightCharts.createChart(chartContainer, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: 'rgba(255,255,255,0.1)' }, horzLines: { color: 'rgba(255,255,255,0.1)' } },
                rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                timeScale: { borderColor: 'rgba(255,255,255,0.1)' }
            });
            
            var series = chart.addCandlestickSeries({
                upColor: '#ff4757', downColor: '#2ed573',
                borderUpColor: '#ff4757', borderDownColor: '#2ed573',
                wickUpColor: '#ff4757', wickDownColor: '#2ed573'
            });
            
            // æ¨¡æ‹Ÿæ•°æ®
            var data = [];
            var price = 100;
            var now = new Date();
            for (var i = 100; i >= 0; i--) {
                var date = new Date(now);
                date.setDate(date.getDate() - i);
                var open = price + (Math.random() - 0.5) * 5;
                var close = open + (Math.random() - 0.5) * 5;
                var high = Math.max(open, close) + Math.random() * 3;
                var low = Math.min(open, close) - Math.random() * 3;
                data.push({
                    time: date.toISOString().split('T')[0],
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2))
                });
                price = close;
            }
            series.setData(data);
            chart.timeScale().fitContent();
        }

        function formatStockCode(code) {
            code = code.replace(/\D/g, '');
            if (code.length !== 6) return code;
            if (code.charAt(0) === '6' || code.charAt(0) === '5') return 'sh' + code;
            return 'sz' + code;
        }

        function fetchStockData() {
            if (!currentUser) return;
            
            var myStocks = watchlist[currentUser];
            if (!myStocks) return;
            
            var codes = [];
            for (var code in myStocks) {
                if (myStocks.hasOwnProperty(code)) {
                    codes.push(formatStockCode(code));
                }
            }
            if (codes.length === 0) return;
            
            var url = 'https://qt.gtimg.cn/q=' + codes.join(',');
            
            fetch(url)
                .then(function(response) { return response.arrayBuffer(); })
                .then(function(buffer) {
                    var decoder = new TextDecoder('GBK');
                    var text = decoder.decode(buffer);
                    
                    var lines = text.split(';');
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        var match = line.match(/v_(\w+)="([^"]+)"/);
                        if (match) {
                            var fullCode = match[1];
                            var code = fullCode.replace(/^(sh|sz|bj)/, '');
                            var data = match[2].split('~');
                            if (data.length > 40) {
                                var price = parseFloat(data[3]);
                                if (!isNaN(price) && price > 0) {
                                    stockData[code] = {
                                        name: data[1] || 'æœªçŸ¥',
                                        price: price,
                                        change: parseFloat(data[4]),
                                        changePercent: parseFloat(data[5]),
                                        open: parseFloat(data[8]) || 0,
                                        high: parseFloat(data[9]) || 0,
                                        low: parseFloat(data[10]) || 0
                                    };
                                }
                            }
                        }
                    }
                    
                    if (document.getElementById('page-portfolio').classList.contains('active')) {
                        renderPortfolio();
                    }
                })
                .catch(function(err) { console.error('Fetch error:', err); });
        }

        // æ¯5ç§’åˆ·æ–°
        setInterval(fetchStockData, 5000);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target.id === 'loginModal') hideLoginModal();
        });
    </script>
</body>
</html>
