# 投顾整体提佣业务需求文档

---

## 需求一：投顾产品信息采集 - 交易分类字段补充

### 1. 需求概述
券商开展投顾整体提佣业务，需针对提佣服务费用按照**资金股份流水五要素**（交易市场、交易类型、买卖类别、证券类别、买卖类别）进行分佣处理，需在投顾产品信息中补充**交易分类**字段。

### 2. 数据库表变更（DDL脚本）

| 序号 | 表名 | 表中文名 | 变更内容 |
|:---:|:---|:---|:---|
| 1 | `bcp_kfee_gx_product` | 产品入库详细信息表 | 新增 `trdtype` 交易分类字段 |
| 2 | `kfee_worth_clear_product` | 投顾产品中间表 | 新增 `trdtype` 交易分类字段 |
| 3 | `kfee_worth_product` | 投顾产品业务表 | 新增 `trdtype` 交易分类字段 |
| 4 | `his_kfee_worth_product` | 投顾产品历史表 | 新增 `trdtype` 交易分类字段 |

**数据库脚本示例：**
```sql
-- 产品入库详细信息表
ALTER TABLE bcp_kfee_gx_product ADD COLUMN trdtype VARCHAR(20) COMMENT '交易分类';

-- 投顾产品中间表  
ALTER TABLE kfee_worth_clear_product ADD COLUMN trdtype VARCHAR(20) COMMENT '交易分类';

-- 投顾产品业务表
ALTER TABLE kfee_worth_product ADD COLUMN trdtype VARCHAR(20) COMMENT '交易分类';

-- 投顾产品历史表
ALTER TABLE his_kfee_worth_product ADD COLUMN trdtype VARCHAR(20) COMMENT '交易分类';
```

### 3. 数据流转（ETL）

```
bcp_kfee_gx_product 
    ↓ 采集任务51401-投顾产品信息采集
    ↓ 补充trdtype采集映射
kfee_worth_clear_product
    ↓ 清算步骤60-提佣产品清洗
    ↓ 补充trdtype字段清洗
kfee_worth_product
    ↓ 清算步骤200-提佣产品数据归档
    ↓ 补充trdtype字段清洗
his_kfee_worth_product
```

| 数据流向 | 任务/步骤 | 处理内容 |
|:---|:---|:---|
| BCP → 中间表 | **51401-投顾产品信息采集** | 补充交易分类[trdtype]采集映射 |
| 中间表 → 业务表 | **60-提佣产品清洗** | 补充交易分类[trdtype]字段清洗 |
| 业务表 → 历史表 | **200-提佣产品数据归档** | 补充交易分类[trdtype]字段清洗 |

### 4. 功能菜单变更

| 模块 | 菜单 | 变更内容 |
|:---|:---|:---|
| 基础管理 | **提佣产品管理** | 新增/修改功能补充**交易分类[trdtype]**字段维护 |

### 5. 影响范围
- 投顾产品信息采集（任务51401）
- 提佣产品管理菜单的新增/修改功能

---

## 需求二：客户交易流水 - 投顾服务费字段补充

### 1. 需求概述
券商开展投顾整体提佣业务，需在客户交易流水中补充**投顾服务费**字段，用于记录和查询提佣服务费用。

### 2. 数据库表变更（DDL脚本）

| 序号 | 表名 | 表中文名 | 变更内容 |
|:---:|:---|:---|:---|
| 1 | `bcp_kfee_gx_logasset` | 客户资金股份流水交割表 | 新增投顾服务费字段 |
| 2 | `kfee_logasset_gs_all` | 客户资金股份成交流水全量表 | 新增投顾服务费字段 |
| 3 | `his_kfee_logasset_gs_all` | 客户资金股份成交流水全量历史表 | 新增投顾服务费字段 |
| 4 | `kfee_logasset` | 客户资金股份成交流水表 | 新增投顾服务费字段 |
| 5 | `his_kfee_logasset` | 客户资金股份成交流水历史表 | 新增投顾服务费字段 |

**数据库脚本示例：**
```sql
-- 客户资金股份流水交割表
ALTER TABLE bcp_kfee_gx_logasset ADD COLUMN invest_consult_fee DECIMAL(18,2) COMMENT '投顾服务费';

-- 客户资金股份成交流水全量表
ALTER TABLE kfee_logasset_gs_all ADD COLUMN invest_consult_fee DECIMAL(18,2) COMMENT '投顾服务费';

-- 客户资金股份成交流水全量历史表
ALTER TABLE his_kfee_logasset_gs_all ADD COLUMN invest_consult_fee DECIMAL(18,2) COMMENT '投顾服务费';

-- 客户资金股份成交流水表
ALTER TABLE kfee_logasset ADD COLUMN invest_consult_fee DECIMAL(18,2) COMMENT '投顾服务费';

-- 客户资金股份成交流水历史表
ALTER TABLE his_kfee_logasset ADD COLUMN invest_consult_fee DECIMAL(18,2) COMMENT '投顾服务费';
```

### 3. 数据流转（ETL）

#### 分支一：当日流水
```
bcp_kfee_gx_logasset
    ↓ 采集任务51504-客户交易流水采集
    ↓ 补充投顾服务费字段采集映射
kfee_logasset_gs_all + kfee_logasset
    ↓ 清算步骤280-资金股份流水表归档
    ↓ 补充投顾服务费字段清洗
his_kfee_logasset
```

#### 分支二：全量流水
```
bcp_kfee_gx_logasset
    ↓ 采集任务51504-客户交易流水采集
    ↓ 补充投顾服务费字段采集映射
kfee_logasset_gs_all
    ↓ 清算步骤480-签约客户资金股份流水全量表归档
    ↓ 补充投顾服务费字段清洗
his_kfee_logasset_gs_all
```

| 数据流向 | 任务/步骤 | 处理内容 |
|:---|:---|:---|
| BCP → 业务表 | **51504-客户交易流水采集** | 补充投顾服务费字段采集映射 |
| 业务表 → 历史表 | **280-资金股份流水表归档** | 补充投顾服务费字段清洗 |
| 全量表 → 历史全量表 | **480-签约客户资金股份流水全量表归档** | 补充投顾服务费字段清洗 |

### 4. 功能菜单变更

| 模块 | 菜单 | 变更内容 |
|:---|:---|:---|
| 报表查询 | **2.C.资金股份流水** | 补充投顾服务费字段**查询与导出** |

### 5. 影响范围
- 客户交易流水采集（任务51504）
- 2.C.资金股份流水查询与导出功能

---

## 汇总对比表

| 维度 | 需求一：投顾产品信息 | 需求二：客户交易流水 |
|:---|:---|:---|
| **核心字段** | 交易分类(trdtype) | 投顾服务费(invest_consult_fee) |
| **涉及表数** | 4张表 | 5张表 |
| **采集任务** | 51401-投顾产品信息采集 | 51504-客户交易流水采集 |
| **清洗步骤** | 60, 200 | 280, 480 |
| **功能菜单** | 提佣产品管理 | 2.C.资金股份流水 |
| **业务目的** | 支撑分佣规则匹配 | 记录提佣服务费用 |

---

## 实施建议

1. **数据库变更先行** - 先执行DDL脚本，确保表结构就绪
2. **ETL任务并行开发** - 采集任务和清洗步骤可同时开发
3. **菜单功能联调** - 最后进行前端页面和报表功能的联调测试
4. **回滚方案** - 建议变更前备份相关表数据，确保可回滚